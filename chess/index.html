<!DOCTYPE html>
<html>

<head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    pear-ctrl[data-platform="darwin"] {
      margin-top: 12px;
      margin-left: 10px;
    }

    #titlebar {
      -webkit-app-region: drag;
      height: 30px;
      width: 100%;
      position: fixed;
      left: 0;
      top: 0;
      background-color: #B0D94413;
      filter: drop-shadow(2px 10px 6px #888);
      z-index: 1000;
    }

    button,
    input {
      all: unset;
      border: 1px ridge #B0D944;
      background: #000;
      color: #B0D944;
      padding: .45rem;
      font-family: monospace;
      font-size: 1rem;
      line-height: 1rem;
    }

    body {
      background-color: #001601;
      font-family: monospace;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    main {
      display: flex;
      height: 100vh;
      width: 100vw;
      color: white;
      padding-top: 30px;
      /* Account for titlebar */
      position: relative;
    }

    .hidden {
      display: none !important;
    }

    #setup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      padding: 40px;
      background: rgba(0, 22, 1, 0.95);
      border: 1px solid #B0D944;
      border-radius: 8px;
      width: 400px;
      box-shadow: 0 4px 20px rgba(176, 217, 68, 0.2);
    }

    #setup button {
      width: 100%;
      text-align: center;
      padding: 12px;
      font-size: 1.2em;
      transition: all 0.2s ease;
      border-radius: 4px;
    }

    #setup button:hover {
      background-color: #B0D944;
      color: #000;
    }

    #setup #join-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-right: 25px;
    }

    #setup #join-form input {
      width: 100%;
      padding: 12px;
      text-align: center;
      border-radius: 4px;
    }

    #or {
      margin: 0;
      color: #B0D944;
      font-size: 1.2em;
    }

    .room-info {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .room-info input {
      flex: 1;
      padding: 8px;
      font-family: monospace;
      border-radius: 4px;
      background: #001601;
      border: 1px solid #B0D944;
      color: #B0D944;
    }

    .copy-button {
      padding: 8px 12px !important;
      width: auto !important;
      font-size: 1em !important;
    }

    .tooltip {
      position: absolute;
      background: #B0D944;
      color: #000;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .tooltip.visible {
      opacity: 1;
    }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5em;
      color: #B0D944;
      padding: 20px;
      background: rgba(0, 22, 1, 0.95);
      border: 1px solid #B0D944;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(176, 217, 68, 0.2);
    }

    #loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '';
      }

      40% {
        content: '.';
      }

      60% {
        content: '..';
      }

      80%,
      100% {
        content: '...';
      }
    }

    #game-container {
      display: flex;
      width: 100%;
      height: calc(100vh - 30px);
      gap: 20px;
      padding: 20px;
    }

    #game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 0;
      /* Prevent flex item from overflowing */
    }

    #chat {
      width: 350px;
      display: flex;
      flex-direction: column;
      padding: .75rem;
      border-left: 1px solid #B0D944;
      height: 100%;
    }

    #header {
      margin-bottom: 0.75rem;
    }

    #details {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #messages {
      flex: 1;
      font-family: 'Courier New', Courier, monospace;
      overflow-y: auto;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #B0D944;
      scrollbar-width: thin;
      scrollbar-color: #B0D944 #001601;
    }

    /* Webkit scrollbar styling */
    #messages::-webkit-scrollbar {
      width: 8px;
    }

    #messages::-webkit-scrollbar-track {
      background: #001601;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #B0D944;
      border-radius: 4px;
    }

    #message-form {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #message {
      flex: 1;
    }

    /* Chess board styles */
    .chess-board {
      width: 640px;
      height: 640px;
      margin: 20px auto;
      border: 2px solid #B0D944;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      position: relative;
    }

    .chess-square {
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .chess-piece {
      width: 65px;
      height: 65px;
      cursor: move;
      user-select: none;
      -webkit-user-drag: element;
      position: relative;
      z-index: 1;
    }

    .chess-piece.dragging {
      opacity: 0.6;
      z-index: 1000;
    }

    .chess-square.valid-drop {
      background: rgba(176, 217, 68, 0.4) !important;
    }

    .chess-square.selected {
      background: rgba(176, 217, 68, 0.3) !important;
    }

    .white {
      background: #EEEED2;
    }

    .black {
      background: #769656;
    }

    #game-status {
      color: #B0D944;
      text-align: center;
      margin: 10px 0;
      font-size: 1.5em;
      padding: 10px;
      background: rgba(0, 22, 1, 0.8);
      border: 1px solid #B0D944;
      border-radius: 4px;
    }

    #debug-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 300px;
      max-height: 200px;
      background: rgba(0, 0, 0, 0.9);
      color: #B0D944;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      overflow-y: auto;
      z-index: 1000;
      border-top: 1px solid #B0D944;
      border-left: 1px solid #B0D944;
    }

    #debug-panel .debug-entry {
      margin: 2px 0;
      padding: 2px 0;
      border-bottom: 1px solid rgba(176, 217, 68, 0.2);
    }

    #debug-panel .error {
      color: #ff6b6b;
    }

    #debug-panel .success {
      color: #B0D944;
    }

    #debug-panel .info {
      color: #4dabf7;
    }

    .quit-button {
      margin-left: 10px;
      padding: 10px 20px;
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .draw-button {
      margin-left: 10px;
      padding: 10px 20px;
      background: #f0ad4e;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .winner-announcement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: winner-animation 1s ease-in-out;
    }

    @keyframes winner-animation {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }

      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }
  </style>
  <script type='module' src='./app.js'></script>
</head>

<body>
  <!-- Debug Panel -->
  <div id="debug-panel"></div>

  <!-- Title Bar -->
  <div id="titlebar">
    <pear-ctrl></pear-ctrl>
  </div>

  <!-- Add audio elements -->
  <audio id="gameBackgroundSound" src="background.mp3" preload="auto" loop></audio>
  <audio id="moveSound" src="move.mp3" preload="auto"></audio>
  <audio id="checkSound" src="check.mp3" preload="auto"></audio>
  <audio id="gameOverSound" src="game-over.mp3" preload="auto"></audio>
  <audio id="gameStartSound" src="game-start.mp3" preload="auto"></audio>

  <main>
    <!-- All game stages -->
    <div id="game-stages">
      <!-- Stage 1: Room Selection -->
      <section id="stage-room-selection" class="stage">
        <h2>Welcome to P2P Chess</h2>
        <div class="stage-content">
          <button id="create-room-btn" class="primary-btn">Create Room</button>
          <div class="divider">or</div>
          <button id="join-room-btn" class="primary-btn">Join Room</button>
        </div>
      </section>

      <!-- Stage 2: Room Setup -->
      <section id="stage-room-setup" class="stage hidden">
        <!-- Create Room Form -->
        <div id="create-room-form" class="setup-form hidden">
          <h2>Create New Room</h2>
          <div class="form-group">
            <input type="text" id="create-username" placeholder="Enter your username" required>
            <br/>
            <label>Select Game Duration:</label>
            <div id="timer-options">
              <button type="button" id="timer-10" class="timer-option" data-time="600">10 Min</button>
              <button type="button" id="timer-15" class="timer-option" data-time="900">15 Min</button>
              <button type="button" id="timer-20" class="timer-option" data-time="1200">20 Min</button>
            </div>
          </div>
          <div id="room-code-display-container" class="hidden">
            <p>Your Room Code:</p>
            <div class="room-code-group">
              <input type="text" id="room-code-display" readonly>
              <button id="copy-room-code" class="secondary-btn">Copy</button>
            </div>
            <p class="waiting-text">Waiting for opponent to join...</p>
          </div>
          <button id="create-room-submit" class="primary-btn">Create Room</button>
        </div>

        <!-- Join Room Form -->
        <div id="join-room-form" class="setup-form hidden">
          <h2>Join Existing Room</h2>
          <div class="form-group">
            <input type="text" id="join-username" placeholder="Enter your username" required>
            <input type="text" id="room-code-input" placeholder="Enter room code" required>
          </div>
          <button id="join-room-submit" class="primary-btn">Join Room</button>
        </div>
      </section>

      <!-- Stage 3: Color Selection -->
      <section id="stage-color-selection" class="stage hidden">
        <h2>Choose Your Color</h2>
        <div class="color-options">
          <button id="select-white" class="color-btn">
            <img src="chesspieces/wK.png" alt="White King">
            <span>Play as White</span>
          </button>
          <button id="select-black" class="color-btn">
            <img src="chesspieces/bK.png" alt="Black King">
            <span>Play as Black</span>
          </button>
        </div>
        <p id="color-selection-status" class="status-message"></p>
      </section>

      <!-- Stage 4: Game Interface -->
      <section id="stage-game" class="stage hidden">
        <div id="game-container">
          <!-- Game Area -->
          <div id="game-area">
            <div id="game-header">
              <div class="player-info" id="opponent-info">
                <span class="username"></span>
                <span class="color"></span>
              </div>
              <div id="game-status"></div>
              <div class="player-info" id="player-info">
                <span class="username"></span>
                <span class="color"></span>
              </div>
              <button id="quit-button" class="quit-button">Quit</button>
              <button id="draw-button" class="draw-button">Offer Draw</button>
              <div class="timer-container">
                <div>White Timer: <span id="white-timer">5:00</span></div>
                <div>Black Timer: <span id="black-timer">5:00</span></div>
              </div>
            </div>
            <div id="chess-board" class="chess-board"></div>
          </div>

          <!-- Chat Area -->
          <div id="chat-area">
            <div class="chat-header">
              <h3>Chat</h3>
              <div class="connection-status">
                Connected Players: <span id="peers-count">0</span>
              </div>
            </div>
            <div id="messages" class="messages-container"></div>
            <form id="message-form" class="message-form">
              <input type="text" id="message" placeholder="Type a message..." required>
              <button type="submit" class="send-btn">Send</button>
            </form>
          </div>
        </div>
      </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay hidden">
      <div class="loader"></div>
      <p id="loading-text">Connecting...</p>
    </div>
  </main>
  <div id="winner-announcement" class="winner-announcement"></div>
</body>

</html>

<!-- Sound Effect by <a href="https://pixabay.com/users/universfield-28281460/?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=144751">Universfield</a> from <a href="https://pixabay.com//?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=144751">Pixabay</a> -->